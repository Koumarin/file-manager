[gd_scene load_steps=3 format=2]

[ext_resource path="res://scn/icon.tscn" type="PackedScene" id=1]

[sub_resource type="GDScript" id=1]
script/source = "extends Panel

export (PackedScene) var Icon

onready var icon_container := $ScrollContainer/GridContainer
onready var directory      := Directory.new()

func _ready() -> void:
	if directory.open('/') != OK:
		printerr('Can\\'t open directory!')
		return
	update()

func change_directory(path: String) -> int:
	var err := directory.change_dir(path)
	update()
	return err

func open_file(path: String, args := '') -> int:
	print('Opening file: ', path)
	return OK

### Updates display with the current directory's files.
func update() -> void:
	var file := ''
	
	clear()
	
	directory.list_dir_begin()
	file = directory.get_next()
	while '' != file:
		var icon = Icon.instance()
		
		if directory.current_is_dir():
			icon.is_directory = true
		icon.set_file_path(file)
		icon.connect('opened', self, '_on_icon_opened')
		icon.add_to_group('Icons')
		icon_container.add_child(icon)
		
		file = directory.get_next()

### Removes all icons currently displayed.
func clear() -> void:
	get_tree().call_group('Icons', 'queue_free')

### We resize the icon container so that it has as many icons
### as it can fit horizontally.
func _resize_icon_container() -> void:
	var icon_size: Vector2 = icon_container.get_child(1).rect_size
	
	if icon_container.rect_size.x + icon_size.x <= rect_size.x:
		icon_container.columns += 1
	elif icon_container.rect_size.x > rect_size.x:
		icon_container.columns -= 1

func _on_icon_opened(icon) -> void:
	var path: String = icon.get_file_path()
	
	print('opening ', path)
	
	if icon.is_directory:
		change_directory(path)
	else:
		open_file(path)

func _on_GridContainer_sort_children() -> void:
	_resize_icon_container()

"

[node name="Main" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0

[node name="Panel" type="Panel" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
script = SubResource( 1 )
Icon = ExtResource( 1 )

[node name="ScrollContainer" type="ScrollContainer" parent="Panel"]
anchor_right = 1.0
anchor_bottom = 1.0

[node name="GridContainer" type="GridContainer" parent="Panel/ScrollContainer"]

[connection signal="sort_children" from="Panel/ScrollContainer/GridContainer" to="Panel" method="_on_GridContainer_sort_children"]

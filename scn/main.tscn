[gd_scene load_steps=6 format=2]

[ext_resource path="res://scn/icon-container.tscn" type="PackedScene" id=1]
[ext_resource path="res://scn/file-tree.tscn" type="PackedScene" id=2]
[ext_resource path="res://scn/title-bar.tscn" type="PackedScene" id=3]
[ext_resource path="res://dat/theme/default.tres" type="Theme" id=4]

[sub_resource type="GDScript" id=1]
script/source = "extends Control

signal directory_changed(directory)

var _history     := []
var _history_idx := 0

onready var directory := Directory.new()

func _ready() -> void:
	if directory.open('/') != OK:
		printerr('Can\\'t open directory!')
		return
	OS.set_window_title(Util.get_relative_path(directory.get_current_dir()))
	_history.append(directory.get_current_dir())
	emit_signal('directory_changed', directory)

func change_directory(path: String, write_history := true) -> int:
	var status: int
	
	status = directory.change_dir(path)
	if status == OK:
		if write_history:
			_history = _history.slice(0, _history_idx)
			_history_idx += 1
			_history.append(directory.get_current_dir())
		OS.set_window_title(Util.get_relative_path(path))
		emit_signal('directory_changed', directory)
	return status

func open_file(path: String, args: PoolStringArray = []) -> int:
	return OS.execute(path, args, false)

func _on_icon_opened(icon) -> void:
	var path: String = icon.get_file_path()
	
	if icon.is_directory:
		change_directory(path)
	else:
		print(Util.get_absolute_path(directory, path))
		open_file(Util.get_absolute_path(directory, path))

func _on_FileTree_directory_selected(path) -> void:
	change_directory(path)

func _on_TitleBar_back_selected() -> void:
	if _history_idx == 0:
		return
	
	_history_idx -= 1
	change_directory(_history[_history_idx], false)

func _on_TitleBar_forward_selected() -> void:
	if _history_idx == len(_history) - 1:
		return
	
	_history_idx += 1
	change_directory(_history[_history_idx], false)
"

[node name="Main" type="Control"]
anchor_right = 1.0
anchor_bottom = 1.0
theme = ExtResource( 4 )
script = SubResource( 1 )

[node name="Panel" type="Panel" parent="."]
anchor_right = 1.0
anchor_bottom = 1.0
mouse_filter = 1
size_flags_horizontal = 3

[node name="VBoxContainer" type="VBoxContainer" parent="Panel"]
anchor_right = 1.0
anchor_bottom = 1.0
size_flags_horizontal = 3
size_flags_vertical = 3

[node name="TitleBar" parent="Panel/VBoxContainer" instance=ExtResource( 3 )]

[node name="HSplitContainer" type="HSplitContainer" parent="Panel/VBoxContainer"]
margin_top = 48.0
margin_right = 1024.0
margin_bottom = 600.0
mouse_filter = 1
size_flags_horizontal = 3
size_flags_vertical = 3
split_offset = -253

[node name="FileTree" parent="Panel/VBoxContainer/HSplitContainer" instance=ExtResource( 2 )]
margin_bottom = 552.0

[node name="IconContainer" parent="Panel/VBoxContainer/HSplitContainer" instance=ExtResource( 1 )]
anchor_right = 0.0
anchor_bottom = 0.0
margin_left = 265.0
margin_right = 1024.0
margin_bottom = 552.0

[connection signal="directory_changed" from="." to="Panel/VBoxContainer/TitleBar" method="_on_directory_changed"]
[connection signal="directory_changed" from="." to="Panel/VBoxContainer/HSplitContainer/IconContainer" method="_on_directory_changed"]
[connection signal="back_selected" from="Panel/VBoxContainer/TitleBar" to="." method="_on_TitleBar_back_selected"]
[connection signal="forward_selected" from="Panel/VBoxContainer/TitleBar" to="." method="_on_TitleBar_forward_selected"]
[connection signal="directory_selected" from="Panel/VBoxContainer/HSplitContainer/FileTree" to="." method="_on_FileTree_directory_selected"]
[connection signal="icon_opened" from="Panel/VBoxContainer/HSplitContainer/IconContainer" to="." method="_on_icon_opened"]
